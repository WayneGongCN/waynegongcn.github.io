<!doctype html>
<html lang="en">
  <head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  
<link rel="stylesheet" href="/lib/bootstrap-5.1.3/css/bootstrap.min.css">

  
<link rel="stylesheet" href="/css/style.css">



  
  
    
<link rel="stylesheet" href="/css/github.css">

    
  

  <title>在司庆小游戏中利用漏洞屠榜 - 风灯零乱</title>
<meta name="generator" content="Hexo 6.0.0"></head>

  <body class="container col-lg-8 col-md-10 justify-content-center">
    <header>
  <nav class="navbar sticky-top navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">风灯零乱</a>

      <ul class="nav text-uppercase">
         
        <li class="nav-item">
          <a class="nav-link" href="/archives"
            >archives</a
          >
        </li>
         
        <li class="nav-item">
          <a class="nav-link" href="/categories"
            >categories</a
          >
        </li>
         
        <li class="nav-item">
          <a class="nav-link" href="/tags"
            >tags</a
          >
        </li>
        
      </ul>
    </div>
  </nav>
</header>


    <section class="container-fluid">
  <div class="pb-3 pt-2">
    <h1>
      在司庆小游戏中利用漏洞屠榜
    </h1>
    <time class="link-secondary fw-light">2020-11-11</time>
  </div>

  <main class="markdown-body">
    <p>公司在 22 周年司庆活动期间推出了一款 H5 小游戏。</p>
<p>在游戏中，玩家通过控制小人躲避障碍来不断提高成绩（跑步米数），在游戏中还会随机掉落各种道具，率先收集齐全套道具的玩家则有机会获得奖品。</p>
<p>本着学（na）习（jiang）的精神对小游戏进行来一番研究，发现游戏存在漏洞，能通过伪造请求的方式直接刷满道具。</p>
<h2 id="游戏介绍"><a href="#游戏介绍" class="headerlink" title="游戏介绍"></a>游戏介绍</h2><p>游戏内容前面已经做过简单介绍，补充一些游戏截图 ⬇️</p>
<p><img src="/images/2020/11/48e4fd9e9ff7fdf1d70232a199273d45.jpeg"></p>
<h2 id="游戏分析"><a href="#游戏分析" class="headerlink" title="游戏分析"></a>游戏分析</h2><p>通过抓包，找到几个关键请求如下：</p>
<p><img src="/images/2020/11/Snipaste_2020-11-11_14-07-47.png"></p>
<p>在游戏中会有四种随机的道具掉落，4 种道具凑满 22 个时即可有机会获得奖品。</p>
<p>分析上面的请求很明显能够猜到 <code>item_id</code> 应该代表了四种不同的道具类型。</p>
<p><code>token</code> 可能是某个密钥或者身份标识，通过对比好几个其他请求后发现 token 总是不变的，这里暂且可以认为是代表了当前用户的身份标识。</p>
<p><code>t</code> 明显是一个时间戳，这些都可以很轻易的进行伪造。</p>
<p>剩下最后一个 <code>sign</code> 则是对当前请求内容的一个签名，表示游戏还是有进行简单的安全验证的。</p>
<p><img src="/images/2020/11/Snipaste_2020-11-11_14-08-29.png"></p>
<p>与上面 <code>drop</code> 请求类似，在碰到障碍后结束游戏并发起 <code>end</code> 请求上报成绩。除了 <code>sign</code> 字段，我们基本上已经可以完全伪造上面的请求。</p>
<p>前后端交互部分我们基本已经摸清，剩下的就是搞清楚 <code>sign</code> 是如何而来的。</p>
<h2 id="Javascript-部分"><a href="#Javascript-部分" class="headerlink" title="Javascript 部分"></a>Javascript 部分</h2><p>带着问题出发，我们没有必要完完全全分析整个游戏的 JavaScript，只需要针对性查看 <code>sign</code> 部分即可。</p>
<p><img src="/images/2020/11/Snipaste_2020-11-11_14-28-25-1024x398.png"></p>
<p>看起来 <code>sign</code> 就是这个 <code>getMd5</code> 方法通过计算参数 <code>e</code> 得到的签名。继续顺藤摸瓜找到 <code>getMd5</code> 方法：</p>
<p><img src="/images/2020/11/Snipaste_2020-11-11_14-37-29-624x703.png"></p>
<p>到这里基本可以确定了，<code>sign</code> 是通过将请求数据的 <code>key</code> 按照字典顺序排序后，再将 <code>value</code> 拼接起来，最后进行 <code>sha256</code> 计算得的到 16 进制签名。</p>
<h2 id="伪造请求"><a href="#伪造请求" class="headerlink" title="伪造请求"></a>伪造请求</h2><p>将相关代码扒出来，加上伪造的相关逻辑：</p>
<pre><code class="hljs javascript"><span class="hljs-keyword">const</span> token = <span class="hljs-string">&#x27;&#x27;</span>
<span class="hljs-keyword">const</span> cookie = <span class="hljs-string">&#x27;&#x27;</span>

<span class="hljs-keyword">const</span> dropURL = <span class="hljs-string">&quot;xxxxx/api/api/collect/drop&quot;</span>;
<span class="hljs-keyword">const</span> endURL =  <span class="hljs-string">&#x27;xxxxx/api/api/game/end&#x27;</span>

<span class="hljs-keyword">const</span> headers = &#123;
  <span class="hljs-string">&quot;Content-Type&quot;</span>: <span class="hljs-string">&quot;application/x-www-form-urlencoded&quot;</span>,
  <span class="hljs-string">&quot;x-requested-with&quot;</span>: <span class="hljs-string">&quot;xxx&quot;</span>,
  cookie,
&#125;;

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getItems</span> (<span class="hljs-params"></span>) </span>&#123;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> type = <span class="hljs-number">1</span>; type &lt; <span class="hljs-number">5</span>; type++) &#123;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">22</span>; i++) &#123;
      <span class="hljs-keyword">const</span> requestData = &#123;<span class="hljs-attr">item_id</span>: type, token, <span class="hljs-attr">t</span>: <span class="hljs-built_in">Date</span>.now()&#125;
      requestData.sign = getMd5(requestData);

      <span class="hljs-keyword">await</span> axios.post(dropURL, requestData, &#123; headers &#125;)
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> &#123;
          res.data.code === <span class="hljs-number">200</span> &amp;&amp; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`成功获取第 <span class="hljs-subst">$&#123;i + <span class="hljs-number">1</span>&#125;</span> 个道具 <span class="hljs-subst">$&#123;type&#125;</span>`</span>)
        &#125;)
        .catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> &#123;
          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`获取道具 <span class="hljs-subst">$&#123;type&#125;</span> 失败`</span>)
        &#125;);
    &#125;
  &#125;
&#125;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span> (<span class="hljs-params">meter</span>) </span>&#123;
  <span class="hljs-keyword">const</span> requestData = &#123;meter, token, <span class="hljs-attr">t</span>: <span class="hljs-built_in">Date</span>.now()&#125;
  requestData.sign = getMd5(requestData);

  axios.post(endURL, requestData, &#123; headers &#125;).then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;
    res.data.code === <span class="hljs-number">200</span> &amp;&amp; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`成功跑了: <span class="hljs-subst">$&#123;meter&#125;</span> 米`</span>)
  &#125;)
&#125;

<span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;开始游戏 ...&#x27;</span>)
getItems().then(<span class="hljs-function">() =&gt;</span> &#123;
  run(<span class="hljs-number">6666</span>)).then(<span class="hljs-function">() =&gt;</span> &#123;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;游戏结束&#x27;</span>)
  &#125;)
&#125;)</code></pre>

<p>效果 ⬇️</p>
<p><img src="/images/2020/11/Snipaste_2020-11-11_14-47-16.png"></p>
<p><img src="/images/2020/11/95ee1c8b915bc3fb2da25839c9deaecd-1-492x1024.jpeg"></p>

  </main>
</sectione>

    
<script src="/lib/bootstrap-5.1.3/js/bootstrap.bundle.min.js"></script>


  </body>
</html>