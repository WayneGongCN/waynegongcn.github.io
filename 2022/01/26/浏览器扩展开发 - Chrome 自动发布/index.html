<!doctype html>
<html lang="en">
  <head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  
<link rel="stylesheet" href="/lib/bootstrap-5.1.3/css/bootstrap.min.css">

  
<link rel="stylesheet" href="/css/style.css">


  <title>Title</title>
<meta name="generator" content="Hexo 6.0.0"></head>

  <body class="container-sm ">
    <div class="col-10 justify-content-center">
      <header>
  <h1 >
    <a href="/">Title</a>
  </h1>

  <nav>
    <ul class="row align-items-center justify-content-end text-uppercase">
      
        
        <li class="col-sm-auto">
          <a href="/archives">archives</a>
        </li>
      
        
        <li class="col-sm-auto">
          <a href="/categories">categories</a>
        </li>
      
        
        <li class="col-sm-auto">
          <a href="/tags">tags</a>
        </li>
      
    </ul>
  </nav>
</header>


      <article class="main">
  <h1 id="post-title">
    浏览器扩展开发 - Chrome 自动发布
  </h1>

  <section class="markdown-body">
    <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>目前 <a target="_blank" rel="noopener" href="https://github.com/WayneGongCN/microsoft-todo-browser-ext">microsoft-todo-browser-ext</a> 在代码提交到 master 分支后，会自动执行 <a target="_blank" rel="noopener" href="https://github.com/WayneGongCN/microsoft-todo-browser-ext/actions">GitHub Action</a> 进行构建，但发布过程仍然需要人工进行手动发布。</p>
<p>为了解决这类重复性操作，减少可能出现的操作失误，将发布过程通过自动化完成。</p>
<h2 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h2><p>当 master 分支触发 tag push 事件后，开始启动 <a target="_blank" rel="noopener" href="https://github.com/WayneGongCN/microsoft-todo-browser-ext/actions">Github Action</a> 进行 CI 构建，构建完成后通过脚本将构建的产物上传到 Chrom Store，并进行自动（或手动）发布。</p>
<p> <a target="_blank" rel="noopener" href="https://developer.chrome.com/docs/webstore/api_index/">Chrome Web Store API</a> 提供了上传、发布 Chrome 插件的相关接口，在 <a target="_blank" rel="noopener" href="https://console.cloud.google.com/home/dashboard">Google Cloud Platform</a> 注册应用并进行简单的配置即可使用。</p>
<p> <a target="_blank" rel="noopener" href="https://github.com/fregante/chrome-webstore-upload">chrome-webstore-upload</a> 这个开源库将 <a target="_blank" rel="noopener" href="https://developer.chrome.com/docs/webstore/api_index/">Chrome Web Store API</a> 进行了封装，简化了鉴权、文件上传的流程，同时还提供了 <a target="_blank" rel="noopener" href="https://github.com/fregante/chrome-webstore-upload-cli">CLI 程序</a> 。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="前置步骤"><a href="#前置步骤" class="headerlink" title="前置步骤"></a>前置步骤</h3><p> <a target="_blank" rel="noopener" href="https://github.com/fregante/chrome-webstore-upload">chrome-webstore-upload</a> 的使用方式已有详细的 <a target="_blank" rel="noopener" href="https://github.com/fregante/chrome-webstore-upload/blob/main/How%20to%20generate%20Google%20API%20keys.md">说明文档</a> 简单来说分为下面几个步骤：</p>
<ol>
<li>在 Google Cloud PlatForm <a target="_blank" rel="noopener" href="https://console.developers.google.com/apis/credentials">创建一个项目</a>；</li>
<li>将新建的项目设为<a target="_blank" rel="noopener" href="https://console.developers.google.com/apis/credentials">公开可访问</a>;</li>
<li>配置 OAuth 同意屏幕，并将自己的 Google 添加到测试账号列表；</li>
<li>为项目<a target="_blank" rel="noopener" href="https://console.developers.google.com/apis/library/chromewebstore.googleapis.com">启用 Chrome Store API</a>；</li>
<li>为项目<a target="_blank" rel="noopener" href="https://console.developers.google.com/apis/credentials">添加一个 Chrome APP 类型的 OAuth Client</a> （这一步将得到一个 <code>clientId</code>）；</li>
<li><a target="_blank" rel="noopener" href="https://console.cloud.google.com/apis/credentials/consent">发布项目</a>；</li>
<li>打开链接： <code>https://accounts.google.com/o/oauth2/auth?response_type=code&amp;scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fchromewebstore&amp;redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob&amp;access_type=offline&amp;approval_prompt=force&amp;client_id=YOUR_CLIENT_ID_HERE</code> （使用上面得到的 <code>ClientID</code> 替换链接最后的参数）</li>
<li>在控制台执行以下代码，获得 <code>refresh_token</code>：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> fetch(<span class="string">&#x27;https://accounts.google.com/o/oauth2/token&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    <span class="attr">body</span>: <span class="keyword">new</span> URLSearchParams([</span><br><span class="line">      [<span class="string">&#x27;client_id&#x27;</span>, prompt(<span class="string">&#x27;Enter your clientId&#x27;</span>)],</span><br><span class="line">      [<span class="string">&#x27;code&#x27;</span>, <span class="keyword">new</span> URLSearchParams(location.search).get(<span class="string">&#x27;approvalCode&#x27;</span>)],</span><br><span class="line">      [<span class="string">&#x27;grant_type&#x27;</span>, <span class="string">&#x27;authorization_code&#x27;</span>],</span><br><span class="line">      [<span class="string">&#x27;redirect_uri&#x27;</span>, <span class="string">&#x27;urn:ietf:wg:oauth:2.0:oob&#x27;</span>]</span><br><span class="line">    ]),</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> json = <span class="keyword">await</span> response.json();</span><br><span class="line">  <span class="built_in">console</span>.log(json);</span><br><span class="line">  <span class="keyword">if</span> (!json.error) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> copy === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      copy(json.refresh_token);</span><br><span class="line">      alert(<span class="string">&#x27;The refresh_token has been copied into your clipboard. You’re done!&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;Copy your token:&#x27;</span>, json.refresh_token);</span><br><span class="line">      alert(<span class="string">&#x27;Copy your refresh_token from the console output. You’re done!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure></li>
<li>保存上面获得的 <code>clientId</code> 和 <code>refresh_token</code> 开始编写上传脚本；</li>
</ol>
<h3 id="编写脚本"><a href="#编写脚本" class="headerlink" title="编写脚本"></a>编写脚本</h3><p>上传脚本 <code>path/to/upload.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&#x27;fs&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> myZipFile = fs.createReadStream(<span class="string">&#x27;./mypackage.zip&#x27;</span>);</span><br><span class="line">store.uploadExisting(myZipFile).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 返回结果参照文档：</span></span><br><span class="line">  <span class="comment">// https://developer.chrome.com/webstore/webstore_api/items#resource</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>发布脚本 <code>path/to/publish.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> target = <span class="string">&#x27;default&#x27;</span>;</span><br><span class="line">store.publish(target).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 返回结果参照文档：</span></span><br><span class="line">  <span class="comment">// https://developer.chrome.com/webstore/webstore_api/items/publish</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="package-json-配置"><a href="#package-json-配置" class="headerlink" title="package.json 配置"></a>package.json 配置</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;script&quot;</span>: &#123;</span><br><span class="line">	<span class="attr">&quot;upload&quot;</span>: <span class="string">&quot;node path/to/uplaod.js&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;publish&quot;</span>: <span class="string">&quot;node path/to/publish.js&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Github-Action-配置"><a href="#Github-Action-配置" class="headerlink" title="Github Action 配置"></a>Github Action 配置</h3><p>TODO</p>

  </section>
</article>
    </div>

    
<script src="/lib/bootstrap-5.1.3/js/bootstrap.bundle.min.js"></script>


  </body>
</html>