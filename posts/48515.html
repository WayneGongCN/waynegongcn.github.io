<!doctype html>
<html lang="en">
  <head>
  <!-- Meta -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  


  
    
    
<link rel="stylesheet" href="/css/github.css">

  

  <meta name="title" content="浏览器扩展开发 - Chrome 自动发布 | 风灯零乱 | 一个程序员的个人博客">
  <meta name="keywords" content="浏览器扩展,自动发布,持续部署,持续集成,博客,独立开发,技术沉淀,思考总结,Web 前端">

  <!-- OpenGraph -->
  <meta name="description" content="背景目前 microsoft-todo-browser-ext 在代码提交到 master 分支后，会自动执行 GitHub Action 进行构建，但发布过程仍然需要人工进行手动发布。 为了解决这类重复性操作，减少可能出现的操作失误，将发布过程通过自动化完成。 方案当 master 分支触发 tag push 事件后，开始启动 Github Action 进行 CI 构建，构建完成后通过脚本将构">
<meta property="og:type" content="article">
<meta property="og:title" content="浏览器扩展开发 - Chrome 自动发布">
<meta property="og:url" content="https://waynegong.cn/posts/48515.html">
<meta property="og:site_name" content="风灯零乱">
<meta property="og:description" content="背景目前 microsoft-todo-browser-ext 在代码提交到 master 分支后，会自动执行 GitHub Action 进行构建，但发布过程仍然需要人工进行手动发布。 为了解决这类重复性操作，减少可能出现的操作失误，将发布过程通过自动化完成。 方案当 master 分支触发 tag push 事件后，开始启动 Github Action 进行 CI 构建，构建完成后通过脚本将构">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-01-28T16:00:00.000Z">
<meta property="article:modified_time" content="2022-02-09T15:59:20.067Z">
<meta property="article:author" content="waynegong">
<meta property="article:tag" content="浏览器扩展开发">
<meta name="twitter:card" content="summary">

  <!-- Title -->
  <title>浏览器扩展开发 - Chrome 自动发布 | 风灯零乱 | 一个程序员的个人博客</title>

  <!-- 收录验证 -->
  <meta name="sogou_site_verification" content="Ya613VDsLE" />
  <meta name="360-site-verification" content="cede68bb0b1448f4d5dcc6cdbdb1239d" />
  <meta name="baidu-site-verification" content="code-CXJVSO2lgq" />

  <!-- GTM -->
  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-K9CJL9P');</script>
  

  <!-- Bootstrap CSS -->
  
<link rel="stylesheet" href="/lib/bootstrap-5.1.3/css/bootstrap.min.css">

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.0.0"></head>

  <body class="container col-lg-8 col-md-10 justify-content-center">
    <header class="container-fluid">
  <nav class="row align-items-center justify-content-between mb-2" style="border-bottom: 2px solid;">
    <a class="col navbar-brand text-dark" href="/">风灯零乱</a>

    <ul class="col-auto row p-0 m-0">
      
        
        <li class="col-auto none-list-style">
          <a class="text-dark text-decoration-none" href="/archives/">
            归档
          </a>
        </li>
      
        
        <li class="col-auto none-list-style">
          <a class="text-dark text-decoration-none" href="/categories/">
            分类
          </a>
        </li>
      
        
        <li class="col-auto none-list-style">
          <a class="text-dark text-decoration-none" href="/tags/">
            标签
          </a>
        </li>
      
    </ul>
  </nav>
</header>


    <section class="container-fluid">
  <div class="pb-3 pt-2">
    <h1>
      浏览器扩展开发 - Chrome 自动发布
    </h1>
    <time class="link-secondary fw-light">2022-01-29</time>
  </div>

  <main class="markdown-body">
    <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>目前 <a target="_blank" rel="noopener" href="https://github.com/WayneGongCN/microsoft-todo-browser-ext">microsoft-todo-browser-ext</a> 在代码提交到 master 分支后，会自动执行 <a target="_blank" rel="noopener" href="https://github.com/WayneGongCN/microsoft-todo-browser-ext/actions">GitHub Action</a> 进行构建，但发布过程仍然需要人工进行手动发布。</p>
<p>为了解决这类重复性操作，减少可能出现的操作失误，将发布过程通过自动化完成。</p>
<h2 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h2><p>当 master 分支触发 tag push 事件后，开始启动 <a target="_blank" rel="noopener" href="https://github.com/WayneGongCN/microsoft-todo-browser-ext/actions">Github Action</a> 进行 CI 构建，构建完成后通过脚本将构建的产物上传到 Chrom Store，并进行自动（或手动）发布。</p>
<p> <a target="_blank" rel="noopener" href="https://developer.chrome.com/docs/webstore/api_index/">Chrome Web Store API</a> 提供了上传、发布 Chrome 插件的相关接口，在 <a target="_blank" rel="noopener" href="https://console.cloud.google.com/home/dashboard">Google Cloud Platform</a> 注册应用并进行简单的配置即可使用。</p>
<p> <a target="_blank" rel="noopener" href="https://github.com/fregante/chrome-webstore-upload">chrome-webstore-upload</a> 这个开源库将 <a target="_blank" rel="noopener" href="https://developer.chrome.com/docs/webstore/api_index/">Chrome Web Store API</a> 进行了封装，简化了鉴权、文件上传的流程，同时还提供了 <a target="_blank" rel="noopener" href="https://github.com/fregante/chrome-webstore-upload-cli">CLI 程序</a> 。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="前置步骤"><a href="#前置步骤" class="headerlink" title="前置步骤"></a>前置步骤</h3><p> <a target="_blank" rel="noopener" href="https://github.com/fregante/chrome-webstore-upload">chrome-webstore-upload</a> 的使用方式已有详细的 <a target="_blank" rel="noopener" href="https://github.com/fregante/chrome-webstore-upload/blob/main/How%20to%20generate%20Google%20API%20keys.md">说明文档</a> 简单来说分为下面几个步骤：</p>
<ol>
<li><p>在 Google Cloud PlatForm <a target="_blank" rel="noopener" href="https://console.developers.google.com/apis/credentials">创建一个项目</a>；</p>
</li>
<li><p>将新建的项目设为<a target="_blank" rel="noopener" href="https://console.developers.google.com/apis/credentials">公开可访问</a>;</p>
</li>
<li><p>配置 OAuth 同意屏幕，并将自己的 Google 添加到测试账号列表；</p>
</li>
<li><p>为项目<a target="_blank" rel="noopener" href="https://console.developers.google.com/apis/library/chromewebstore.googleapis.com">启用 Chrome Store API</a>；</p>
</li>
<li><p>为项目<a target="_blank" rel="noopener" href="https://console.developers.google.com/apis/credentials">添加一个 Chrome APP 类型的 OAuth Client</a> （这一步将得到一个 <code>clientId</code>）；</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://console.cloud.google.com/apis/credentials/consent">发布项目</a>；</p>
</li>
<li><p>使用上面得到的 <code>ClientID</code> 替换链接 <code>client_id</code> 参数：</p>
<pre><code class="hljs text">https://accounts.google.com/o/oauth2/auth?response_type=code&amp;scope=https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fchromewebstore&amp;redirect_uri=urn%3Aietf%3Awg%3Aoauth%3A2.0%3Aoob&amp;access_type=offline&amp;approval_prompt=force&amp;client_id=YOUR_CLIENT_ID_HERE</code></pre></li>
<li><p>在控制台执行 <a target="_blank" rel="noopener" href="https://github.com/fregante/chrome-webstore-upload/blob/main/How%20to%20generate%20Google%20API%20keys.md#:~:text=Run%20this%20in%20your%20browser%20console%20on%20that%20last%20page.%20It%27s%20a%20wizard%20to%20create%20your%20refresh_token%3A"><strong>代码</strong></a>，获得 <code>refresh_token</code>;</p>
</li>
<li><p>保存上面获得的 <code>clientId</code> 和 <code>refresh_token</code> 开始编写上传脚本；</p>
</li>
</ol>
<h3 id="编写脚本"><a href="#编写脚本" class="headerlink" title="编写脚本"></a>编写脚本</h3><p>上传脚本 <code>path/to/upload.js</code></p>
<pre><code class="hljs javascript"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;fs&#x27;</span>;

<span class="hljs-keyword">const</span> myZipFile = fs.createReadStream(<span class="hljs-string">&#x27;./mypackage.zip&#x27;</span>);
store.uploadExisting(myZipFile).then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;
  <span class="hljs-comment">// 返回结果参照文档：</span>
  <span class="hljs-comment">// https://developer.chrome.com/webstore/webstore_api/items#resource</span>
&#125;);</code></pre>

<p>发布脚本 <code>path/to/publish.js</code></p>
<pre><code class="hljs javascript"><span class="hljs-keyword">const</span> target = <span class="hljs-string">&#x27;default&#x27;</span>;

store.publish(target).then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;
  <span class="hljs-comment">// 返回结果参照文档：</span>
  <span class="hljs-comment">// https://developer.chrome.com/webstore/webstore_api/items/publish</span>
&#125;);</code></pre>

<h3 id="package-json-配置"><a href="#package-json-配置" class="headerlink" title="package.json 配置"></a>package.json 配置</h3><pre><code class="hljs json">&#123;
  <span class="hljs-attr">&quot;script&quot;</span>: &#123;
    <span class="hljs-attr">&quot;upload&quot;</span>: <span class="hljs-string">&quot;node path/to/uplaod.js&quot;</span>,
    <span class="hljs-attr">&quot;publish&quot;</span>: <span class="hljs-string">&quot;node path/to/publish.js&quot;</span>
  &#125;
&#125;</code></pre>
<h3 id="Github-Action-配置"><a href="#Github-Action-配置" class="headerlink" title="Github Action 配置"></a>Github Action 配置</h3><p>Github Action 配置参考 <a target="_blank" rel="noopener" href="https://github.com/WayneGongCN/microsoft-todo-browser-ext/blob/main/.github/workflows/upload.yml">upload.yml</a></p>

  </main>
</sectione>

    
<script src="/lib/bootstrap-5.1.3/js/bootstrap.bundle.min.js"></script>


  </body>
</html>