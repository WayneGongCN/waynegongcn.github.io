<!doctype html>
<html lang="en">
  <head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-K9CJL9P');</script>
  


  <!-- Bootstrap CSS -->
  
<link rel="stylesheet" href="/lib/bootstrap-5.1.3/css/bootstrap.min.css">

  
<link rel="stylesheet" href="/css/style.css">



  
  
    
<link rel="stylesheet" href="/css/github.css">

    
  

  <title>Docker 部署 Nginx、frp 实现内网穿透 - 风灯零乱</title>
<meta name="generator" content="Hexo 6.0.0"></head>

  <body class="container col-lg-8 col-md-10 justify-content-center">
    <header>
  <nav class="navbar sticky-top navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">风灯零乱</a>

      <ul class="nav text-uppercase">
         
        <li class="nav-item">
          <a class="nav-link" href="/archives"
            >archives</a
          >
        </li>
         
        <li class="nav-item">
          <a class="nav-link" href="/categories"
            >categories</a
          >
        </li>
         
        <li class="nav-item">
          <a class="nav-link" href="/tags"
            >tags</a
          >
        </li>
        
      </ul>
    </div>
  </nav>
</header>


    <section class="container-fluid">
  <div class="pb-3 pt-2">
    <h1>
      Docker 部署 Nginx、frp 实现内网穿透
    </h1>
    <time class="link-secondary fw-light">2020-03-23</time>
  </div>

  <main class="markdown-body">
    <p>由于没有公网 IP，加上黑群晖没有洗白，无法进行外网的远程连接。</p>
<p>通过 frp 内网穿透后可以通过 sub.domain.com:xxx 的形式访问到内网的 web 服务，但是带上端口号十分不优雅也难以记忆。</p>
<p>在公网服务器上部署 Nginx 反向代理到 frp 的特定端口，即可在使用内网服务时不需要端口号了。</p>
<h2 id="服务端部署"><a href="#服务端部署" class="headerlink" title="服务端部署"></a>服务端部署</h2><p>通过 docker-compose 启动 Dcoker 容器，保持 Nginx 与 frp 两个容器在同一个 Network 下即可在 nginx 容器中将请求转发到 frp 容器。</p>
<p>前置条件：</p>
<ul>
<li>服务端需要 docker 环境及 docker-compose</li>
<li><a target="_blank" rel="noopener" href="https://hub.docker.com/_/nginx">Nginx 镜像</a></li>
<li><a target="_blank" rel="noopener" href="https://hub.docker.com/r/snowdreamtech/frps">snowdreamtech/frps 镜像</a></li>
</ul>
<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><pre><code class="hljs plaintext">.
├── docker-compose.yml
├── frp
│   └── config
│       └── frps.ini
└── nginx
    ├── config
    │   ├── conf.d
    │   │   └── default.conf
    │   └── nginx.conf
    └── logs
        ├── access.log
        └── error.log</code></pre>

<p>docker-compose.yml 内容如下：</p>
<pre><code class="hljs yml"><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3&quot;</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">nginx:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">nginx</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./nginx/config/nginx.conf:/etc/nginx/nginx.conf</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./nginx/config/conf.d:/etc/nginx/conf.d</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./nginx/logs:/var/log/nginx</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;80:80&quot;</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">NGINX_PORT=80</span>
    <span class="hljs-attr">links:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">frp</span>
  
  <span class="hljs-attr">frp:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">snowdreamtech/frps</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">frp</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;7000:7000&quot;</span> <span class="hljs-comment"># 里的端口与 frps.ini 中 bind_port 保持一致</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./frp/config/frps.ini:/etc/frp/frps.ini</span></code></pre>


<p>nginx 的 default.conf 配置文件（可以先 run 一个 nginx 容器然后 通过 docker cp 得到默认配置）:</p>
<pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;
    <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span>;
    <span class="hljs-attribute">server_name</span>  <span class="hljs-regexp">*.domain.com</span>;
    <span class="hljs-attribute">location</span> / &#123;
        <span class="hljs-attribute">proxy_pass</span> http://frp:8888; <span class="hljs-comment"># 这里的端口与 frps.ini 中 vhost_http_port 保持一致</span>
        <span class="hljs-attribute">proxy_set_header</span>    Host $host;
        <span class="hljs-attribute">proxy_set_header</span>    X-Real-IP $remote_addr;
        <span class="hljs-attribute">proxy_set_header</span>    X-Forwarded-Proto https;
        <span class="hljs-attribute">proxy_set_header</span>    X-Forwarded-For $proxy_add_x_forwarded_for;
    &#125;
&#125;</code></pre>

<p>frps.ini 配置文件：</p>
<pre><code class="hljs ini"><span class="hljs-section">[common]</span>
<span class="hljs-attr">bind_port</span> = <span class="hljs-number">7000</span>
<span class="hljs-attr">vhost_http_port</span> = <span class="hljs-number">8888</span>
frpc.ini 配置文件（这里是 frp 客户端配置，仅做参考）:

<span class="hljs-section">[common]</span>
<span class="hljs-attr">server_addr</span> = x.x.x.x
<span class="hljs-attr">server_port</span> = <span class="hljs-number">7000</span>
<span class="hljs-section">[xx sercer]</span>
<span class="hljs-attr">type</span> = http
<span class="hljs-attr">local_port</span> = xxx
<span class="hljs-attr">custom_domains</span> = sub.domain.com</code></pre>

<p>完成所有配置之后在 docker-compose.yml 所在的目录执行 docker-compose up 完成验证即可。</p>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>按照上述配置之后，原来通过 sub.domain.com:8888 才能访问的内网 web 服务现在只需要通过 sub.domain.com 访问即可。</p>

  </main>
</sectione>

    
<script src="/lib/bootstrap-5.1.3/js/bootstrap.bundle.min.js"></script>


  </body>
</html>